<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVCharging - Panel de Monitorizaci√≥n</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 20px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .cp-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .cp-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .cp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .cp-id {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .cp-state {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .state-ACTIVADO {
            background: #10b981;
            color: white;
        }

        .state-PARADO {
            background: #f59e0b;
            color: white;
        }

        .state-SUMINISTRANDO {
            background: #10b981;
            color: white;
            animation: pulse 2s infinite;
        }

        .state-AVERIADO {
            background: #ef4444;
            color: white;
        }

        .state-DESCONECTADO {
            background: #6b7280;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .cp-info {
            margin: 10px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-label {
            color: #6b7280;
            font-size: 0.9em;
        }

        .info-value {
            font-weight: 600;
            color: #333;
        }

        .supply-data {
            background: #f0fdf4;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #10b981;
        }

        .supply-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.95em;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-stop {
            background: #f59e0b;
            color: white;
        }

        .btn-stop:hover {
            background: #d97706;
        }

        .btn-resume {
            background: #10b981;
            color: white;
        }

        .btn-resume:hover {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notif-success {
            background: #10b981;
            color: white;
        }

        .notif-error {
            background: #ef4444;
            color: white;
        }

        .notif-info {
            background: #3b82f6;
            color: white;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .connected {
            background: #10b981;
            color: white;
        }

        .disconnected {
            background: #ef4444;
            color: white;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîå EVCharging Network - Panel de Monitorizaci√≥n</h1>
        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" style="background: #10b981;"></span>
                <span>Activados: <strong id="count-activado">0</strong></span>
            </div>
            <div class="status-item">
                <span class="status-dot" style="background: #10b981; animation: pulse 2s infinite;"></span>
                <span>Suministrando: <strong id="count-suministrando">0</strong></span>
            </div>
            <div class="status-item">
                <span class="status-dot" style="background: #f59e0b;"></span>
                <span>Parados: <strong id="count-parado">0</strong></span>
            </div>
            <div class="status-item">
                <span class="status-dot" style="background: #ef4444;"></span>
                <span>Averiados: <strong id="count-averiado">0</strong></span>
            </div>
            <div class="status-item">
                <span class="status-dot" style="background: #6b7280;"></span>
                <span>Desconectados: <strong id="count-desconectado">0</strong></span>
            </div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #10b981;"></div>
            <span>Activado / Suministrando</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f59e0b;"></div>
            <span>Parado (Fuera de Servicio)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef4444;"></div>
            <span>Averiado</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #6b7280;"></div>
            <span>Desconectado</span>
        </div>
    </div>

    <div class="grid-container" id="cp-grid">
        <!-- Las tarjetas de CPs se generar√°n din√°micamente -->
    </div>

    <div class="connection-status connected" id="connection-status">
        üü¢ Conectado
    </div>

    <script>
        // Debug: Configurar Socket.IO con logs
        console.log('[DEBUG] Iniciando conexi√≥n WebSocket...');
        
        // Conectar al WebSocket
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
        });

        socket.on('connect', () => {
            console.log('[DEBUG] WebSocket conectado - ID:', socket.id);
            document.getElementById('connection-status').className = 'connection-status connected';
            document.getElementById('connection-status').innerHTML = 'üü¢ Conectado';
            socket.emit('request_state');
        });

        socket.on('disconnect', () => {
            console.log('[DEBUG] WebSocket desconectado');
            document.getElementById('connection-status').className = 'connection-status disconnected';
            document.getElementById('connection-status').innerHTML = 'üî¥ Desconectado';
        });

        socket.on('connect_error', (error) => {
            console.error('[DEBUG] Error de conexi√≥n:', error);
        });

        socket.on('update_cps', (data) => {
            console.log('[DEBUG] Datos recibidos:', data);
            updateCPGrid(data.charging_points);
        });

        socket.on('notification', (data) => {
            console.log('[DEBUG] Notificaci√≥n recibida:', data);
            showNotification(data.message, data.type);
        });

        function updateCPGrid(cps) {
            const grid = document.getElementById('cp-grid');
            
            // Contador de estados
            const counts = {
                ACTIVADO: 0,
                SUMINISTRANDO: 0,
                PARADO: 0,
                AVERIADO: 0,
                DESCONECTADO: 0
            };

            // Generar HTML de las tarjetas
            grid.innerHTML = cps.map(cp => {
                const state = cp.state || 'DESCONECTADO';
                counts[state] = (counts[state] || 0) + 1;

                const isSupplying = state === 'SUMINISTRANDO';
                const canControl = ['ACTIVADO', 'PARADO'].includes(state);

                return `
                    <div class="cp-card">
                        <div class="cp-header">
                            <div class="cp-id">${cp.id}</div>
                            <div class="cp-state state-${state}">${state}</div>
                        </div>
                        <div class="cp-info">
                            <div class="info-row">
                                <span class="info-label">üìç Ubicaci√≥n:</span>
                                <span class="info-value">${cp.location || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üí∞ Precio:</span>
                                <span class="info-value">‚Ç¨${(cp.price || 0).toFixed(2)}/kWh</span>
                            </div>
                            ${isSupplying ? `
                                <div class="supply-data">
                                    <div class="supply-row">
                                        <span>‚ö° Potencia actual:</span>
                                        <strong>${(cp.current_kw || 0).toFixed(1)} kW</strong>
                                    </div>
                                    <div class="supply-row">
                                        <span>üîã Energ√≠a total:</span>
                                        <strong>${(cp.total_kwh || 0).toFixed(2)} kWh</strong>
                                    </div>
                                    <div class="supply-row">
                                        <span>üí∂ Importe:</span>
                                        <strong>‚Ç¨${(cp.current_euros || 0).toFixed(2)}</strong>
                                    </div>
                                    ${cp.current_driver ? `
                                        <div class="supply-row">
                                            <span>üë§ Conductor:</span>
                                            <strong>${cp.current_driver}</strong>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            ${state === 'PARADO' ? `
                                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin-top: 10px; text-align: center; font-weight: 600; color: #92400e;">
                                    ‚ö†Ô∏è Out of Order
                                </div>
                            ` : ''}
                        </div>
                        ${canControl ? `
                            <div class="actions">
                                <button class="btn btn-stop" onclick="sendCommand('${cp.id}', 'stop')" ${state === 'PARADO' ? 'disabled' : ''}>
                                    ‚è∏Ô∏è Parar
                                </button>
                                <button class="btn btn-resume" onclick="sendCommand('${cp.id}', 'resume')" ${state === 'ACTIVADO' ? 'disabled' : ''}>
                                    ‚ñ∂Ô∏è Reanudar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Actualizar contadores
            document.getElementById('count-activado').textContent = counts.ACTIVADO || 0;
            document.getElementById('count-suministrando').textContent = counts.SUMINISTRANDO || 0;
            document.getElementById('count-parado').textContent = counts.PARADO || 0;
            document.getElementById('count-averiado').textContent = counts.AVERIADO || 0;
            document.getElementById('count-desconectado').textContent = counts.DESCONECTADO || 0;
        }

        async function sendCommand(cpId, action) {
            try {
                const response = await fetch(`/api/charging_points/${cpId}/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action })
                });

                if (response.ok) {
                    showNotification(`Comando ${action} enviado a ${cpId}`, 'success');
                    // Solicitar actualizaci√≥n inmediata
                    socket.emit('request_state');
                } else {
                    showNotification(`Error al enviar comando a ${cpId}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification notif-${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Solicitar estado inicial
        socket.emit('request_state');
    </script>
</body>
</html>